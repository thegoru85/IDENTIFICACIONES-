<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID Camera App - SEARS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #camera-feed {
            width: 100%;
            max-width: 300px;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: none;
            /* El video se usa como fondo */
        }
        
        /* Contenedor principal de la cámara y el recuadro para que se superpongan */
        #camera-and-crop-container {
            position: relative;
            width: 100%;
            max-width: 300px; /* Limita el ancho del contenedor */
            margin: 0 auto;
            display: flex;
            justify-content: center;
        }
        
        /* El cuadro de recorte ahora está dentro de un contenedor que es del mismo tamaño que el video */
        #crop-box-overlay {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100%;
            pointer-events: none; /* Permite clics a través del overlay */
            display: none;
        }

        #real-time-crop-box {
            position: absolute;
            border: 3px dashed #dc2626; /* Inicialmente rojo (guía) */
            background-color: rgba(220, 38, 38, 0.1);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            cursor: move;
            display: none;
            pointer-events: auto; /* Permite mover este elemento */
            transition: border-color 0.3s, background-color 0.3s; /* Transición para el cambio de color */
        }
        
        #cropped-canvas { /* Este canvas ya no muestra la imagen en el paso de recorte, se usa para tomar la foto */
            display: none; 
        }

        #result-canvas {
            width: 100%;
            max-width: 250px;
            height: auto;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
        }
        #final-document {
            width: 100%;
            max-width: 800px;
            min-height: 1056px;
            background: white;
            margin: 20px auto;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: none;
        }
        .btn-mobile {
            padding: 12px 20px;
            font-size: 16px;
            min-height: 50px;
        }
        .container-mobile {
            max-width: 95%;
            margin: 10px auto;
        }
        .id-size-guide {
            /* Se mantiene el estilo de guía, pero se reemplaza por el cuadro dinámico */
            display: none;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #final-document, #final-document * {
                visibility: visible;
            }
            #final-document {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 100%;
                box-shadow: none;
                margin: 0;
                padding: 20px;
            }
        }
    </style>
</head>
<body class="bg-red-600 text-gray-800 p-3 min-h-screen flex flex-col items-center justify-center">

    <div class="relative container-mobile w-full bg-white rounded-xl shadow-2xl p-4 space-y-4 flex flex-col items-center">
        <div class="absolute top-3 left-3 w-12 h-12 bg-red-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
            SEARS
        </div>

        <h1 class="text-2xl font-bold text-center text-gray-900 mt-6">ID Camera App</h1>
        <div class="font-bold text-xl text-center text-indigo-600 tracking-wider">
            CRÉDITO SEARS
        </div>
        <p class="text-xs text-center text-gray-500">Toma una foto, recorta y genera documento para impresión/envío</p>

        <div id="app-container" class="w-full flex flex-col items-center space-y-3">

            <div id="status-message" class="text-sm font-medium text-gray-600 text-center min-h-20px">
                Pulsa "Abrir cámara" para empezar.
            </div>
            
            <div id="permission-instructions" class="w-full bg-red-100 p-3 rounded-lg text-red-700 hidden">
                <h3 class="font-bold text-base mb-2">Permiso de cámara denegado</h3>
                <p class="mb-2 text-sm">Para usar esta aplicación, necesitas permitir el acceso a la cámara:</p>
                <ul class="list-disc list-inside space-y-1 text-xs">
                    <li><strong>Chrome/Edge:</strong> Haz clic en el icono de cámara bloqueada</li>
                    <li><strong>Safari:</strong> Ajustes > Safari > Cámara</li>
                </ul>
            </div>

            <div id="size-guide" class="w-full text-center hidden">
                <p id="guide-text" class="text-sm text-gray-600 mb-2">🔴 Encuadra la identificación dentro del marco rojo</p>
                <div class="id-size-guide"></div>
            </div>

            <div id="camera-and-crop-container" class="w-full">
                <video id="camera-feed" class="rounded-lg shadow-md" autoplay playsinline></video>
                
                <div id="crop-box-overlay">
                    <div id="real-time-crop-box" class="absolute"></div>
                </div>
            </div>

            <canvas id="photo-canvas" class="hidden"></canvas>
            <canvas id="cropped-canvas" class="hidden"></canvas>
            <div id="crop-container" class="hidden"></div>
            <div id="crop-box" class="hidden"></div>


            <div id="button-container" class="w-full flex flex-col space-y-2 mt-3">
                <button id="start-camera" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md btn-mobile">
                    📷 Abrir cámara
                </button>
                <button id="take-photo" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md btn-mobile hidden">
                    📸 Tomar foto
                </button>
                <button id="crop-photo" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md btn-mobile hidden">
                    ✂️ Confirmar Recorte
                </button>
            </div>

            <div id="result-area" class="w-full flex flex-col items-center space-y-3 mt-3 hidden">
                <p class="text-center text-gray-600 font-medium">Previsualización de imagen recortada:</p>
                <canvas id="result-canvas" class="rounded-lg shadow-md"></canvas>
                
                <div class="w-full flex flex-col space-y-2">
                    <button id="generate-doc-btn" class="w-full bg-gray-500 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md btn-mobile">
                    📄 Generar Documento PDF
                    </button>
                    <button id="download-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md btn-mobile">
                        💾 Descargar imagen
                    </button>
                    <button id="rotate-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md btn-mobile">
                        🔄 Rotar 90°
                    </button>
                </div>
                <button id="restart-btn" class="text-sm text-gray-500 hover:text-gray-700 mt-2 font-medium">
                    🔁 Tomar otra foto
                </button>
            </div>
        </div>
    </div>

    <div id="final-document" class="hidden">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800">SEARS MÉXICO</h1>
            <h2 class="text-xl text-gray-600">CRÉDITO SEARS</h2>
            <p class="text-gray-500">Documento de identificación del cliente (Para Impresión)</p>
            <hr class="my-4 border-gray-300">
        </div>
        
        <div class="grid grid-cols-2 gap-8 mb-8">
            <div>
                <h3 class="font-bold text-lg mb-4 text-gray-700">Identificación Frontal</h3>
                <img id="doc-front-image" src="" alt="Identificación Frontal" class="w-full max-w-xs mx-auto border border-gray-300 rounded shadow-sm">
            </div>
            <div>
                <h3 class="font-bold text-lg mb-4 text-gray-700">Identificación Reverso</h3>
                <img id="doc-back-image" src="" alt="Identificación Reverso" class="w-full max-w-xs mx-auto border border-gray-300 rounded shadow-sm">
            </div>
        </div>

        <div class="mt-12 pt-8 border-t border-gray-300">
            <div class="grid grid-cols-2 gap-8 text-sm text-gray-600">
                <div>
                    <p><strong>Fecha de captura:</strong> <span id="capture-date"></span></p>
                    <p><strong>Hora:</strong> <span id="capture-time"></span></p>
                </div>
                <div>
                    <p><strong>Procesado por:</strong> ID Camera App SEARS</p>
                    <p><strong>Documento generado:</strong> <span id="generation-time"></span></p>
                </div>
            </div>
        </div>

        <div class="mt-8 text-center text-xs text-gray-500">
            <p>Este documento ha sido generado automáticamente para fines de verificación de identidad</p>
            <p>SEARS México - Todos los derechos reservados</p>
        </div>
    </div>

    <script>
        // Declaración de variables globales
        const cameraFeed = document.getElementById('camera-feed');
        const photoCanvas = document.getElementById('photo-canvas');
        const resultCanvas = document.getElementById('result-canvas');
        const startCameraBtn = document.getElementById('start-camera');
        const takePhotoBtn = document.getElementById('take-photo');
        const cropPhotoBtn = document.getElementById('crop-photo');
        const rotateBtn = document.getElementById('rotate-btn');
        const generateDocBtn = document.getElementById('generate-doc-btn');
        const resultArea = document.getElementById('result-area');
        const permissionInstructions = document.getElementById('permission-instructions');
        const statusMessage = document.getElementById('status-message');
        const finalDocument = document.getElementById('final-document');
        const guideText = document.getElementById('guide-text');
        
        // NUEVOS ELEMENTOS DE OVERLAY
        const cameraAndCropContainer = document.getElementById('camera-and-crop-container');
        const cropBoxOverlay = document.getElementById('crop-box-overlay');
        const realTimeCropBox = document.getElementById('real-time-crop-box');
        
        // Botón de Correo (Creado y añadido dinámicamente)
        const sendEmailBtn = document.createElement('button');
        sendEmailBtn.id = 'send-email-btn';
        sendEmailBtn.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md btn-mobile hidden';
        sendEmailBtn.innerHTML = '📧 Enviar por Correo';
        const downloadBtn = document.getElementById('download-btn');
        const resultButtonContainer = resultArea.querySelector('.w-full.flex.flex-col.space-y-2');
        resultButtonContainer.insertBefore(sendEmailBtn, downloadBtn);
        
        // Variables de estado
        let stream = null;
        let isDragging = false;
        let startX, startY;
        let rotation = 0;
        let cropCoordinates = { x: 0, y: 0, width: 0, height: 0 }; // Coordenadas en píxeles de pantalla (DOM)
        let imageCoordinates = { x: 0, y: 0, width: 0, height: 0 }; // Coordenadas en píxeles de la imagen (Video)
        let capturedImages = { front: null, back: null };
        let currentSide = 'front';
        let captureDateTime = null; 

        // Coeficiente para determinar si la ID está "bien encuadrada"
        const MAX_OUT_OF_BOUNDS_PX = 10; 

        // --- Funciones Auxiliares ---

        function showStatus(message) {
            statusMessage.textContent = message;
        }

        function showElement(el) { 
            el.classList.remove('hidden'); 
        }
        function hideElement(el) { 
            el.classList.add('hidden'); 
        }
        
        function getCropBoxRect() {
            return realTimeCropBox.getBoundingClientRect();
        }

        // --- Lógica del Recuadro en Tiempo Real ---

        // Inicializar el cuadro de recorte (ahora sobre el video)
        function initializeCropBox() {
            const videoRect = cameraFeed.getBoundingClientRect();
            
            // Proporción 2:3 (vertical para IDs)
            let boxHeight = videoRect.height * 0.6;
            let boxWidth = boxHeight * 0.66;
            
            // Asegurarse de que no exceda el ancho/alto del video
            if (boxWidth > videoRect.width) {
                boxWidth = videoRect.width * 0.8;
                boxHeight = boxWidth / 0.66;
            }

            const boxX = (videoRect.width - boxWidth) / 2;
            const boxY = (videoRect.height - boxHeight) / 2;
            
            // Aplicar estilos y posición al elemento DOM
            realTimeCropBox.style.width = boxWidth + 'px';
            realTimeCropBox.style.height = boxHeight + 'px';
            realTimeCropBox.style.left = boxX + 'px';
            realTimeCropBox.style.top = boxY + 'px';

            // Guardar coordenadas de pantalla
            cropCoordinates = {
                x: boxX,
                y: boxY,
                width: boxWidth,
                height: boxHeight
            };
            rotation = 0;
            
            updateCropBoxStyle(); // Establecer el color inicial
            showElement(cropBoxOverlay);
            showElement(realTimeCropBox);
        }

        // Verifica si el recuadro está fuera de los límites de la pantalla del video
        function isOutOfBounds(rect) {
            const videoRect = cameraFeed.getBoundingClientRect();
            
            // Margen para considerar "dentro"
            const margin = -MAX_OUT_OF_BOUNDS_PX; 

            return (
                rect.left < videoRect.left - margin ||
                rect.right > videoRect.right + margin ||
                rect.top < videoRect.top - margin ||
                rect.bottom > videoRect.bottom + margin
            );
        }

        // Actualiza el color del recuadro (rojo/verde) y el mensaje
        function updateCropBoxStyle() {
            const rect = getCropBoxRect();
            const videoRect = cameraFeed.getBoundingClientRect();

            // Usamos las coordenadas de pantalla (DOM) para esta lógica visual
            const isInside = (
                rect.left >= videoRect.left &&
                rect.right <= videoRect.right &&
                rect.top >= videoRect.top &&
                rect.bottom <= videoRect.bottom
            );

            if (isInside) {
                // Cuadro verde (bien encuadrado)
                realTimeCropBox.style.borderColor = '#059669'; // green-600
                realTimeCropBox.style.backgroundColor = 'rgba(5, 150, 105, 0.15)';
                guideText.textContent = '🟢 ¡Encuadrado! Pulsa "Tomar foto"';
                takePhotoBtn.disabled = false;
            } else {
                // Cuadro rojo (fuera de margen)
                realTimeCropBox.style.borderColor = '#dc2626'; // red-600
                realTimeCropBox.style.backgroundColor = 'rgba(220, 38, 38, 0.15)';
                guideText.textContent = '🔴 Ajusta el recuadro verde DENTRO de la pantalla';
                takePhotoBtn.disabled = true; // Deshabilita tomar foto si está fuera
            }
        }

        // Eventos para arrastrar el cuadro de recorte (sobre el video)
        realTimeCropBox.addEventListener('mousedown', startDragging);
        realTimeCropBox.addEventListener('touchstart', startDragging, { passive: false });

        function startDragging(e) {
            e.preventDefault();
            isDragging = true;
            
            if (e.type === 'mousedown') {
                startX = e.clientX;
                startY = e.clientY;
            } else {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            }
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('mouseup', stopDragging);
            document.addEventListener('touchend', stopDragging);
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            let currentX, currentY;
            
            if (e.type === 'mousemove') {
                currentX = e.clientX;
                currentY = e.clientY;
            } else {
                currentX = e.touches[0].clientX;
                currentY = e.touches[0].clientY;
            }
            
            const deltaX = currentX - startX;
            const deltaY = currentY - startY;
            
            const videoRect = cameraFeed.getBoundingClientRect();

            // Calcular nueva posición
            const newX = cropCoordinates.x + deltaX;
            const newY = cropCoordinates.y + deltaY;
            
            // Restringir movimiento DENTRO del contenedor del video (videoRect)
            const restrictedX = Math.max(0, Math.min(videoRect.width - cropCoordinates.width, newX));
            const restrictedY = Math.max(0, Math.min(videoRect.height - cropCoordinates.height, newY));
            
            // Actualizar posición visual (DOM)
            realTimeCropBox.style.left = restrictedX + 'px';
            realTimeCropBox.style.top = restrictedY + 'px';
            
            // Actualizar coordenadas para el siguiente drag
            cropCoordinates.x = restrictedX;
            cropCoordinates.y = restrictedY;
            
            startX = currentX;
            startY = currentY;
            
            updateCropBoxStyle();
        }

        function stopDragging() {
            isDragging = false;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('mouseup', stopDragging);
            document.removeEventListener('touchend', stopDragging);
            updateCropBoxStyle();
        }
        
        // --- Funciones de Lógica de la Aplicación ---

        // Evento: Iniciar la cámara
        startCameraBtn.addEventListener('click', async () => {
            showStatus('🔄 Accediendo a la cámara...');
            hideElement(permissionInstructions);
            
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment', 
                        width: { ideal: 720 },
                        height: { ideal: 1280 },
                        aspectRatio: { ideal: 9/16 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = stream;
                
                // Esperar a que el video cargue para obtener dimensiones correctas
                cameraFeed.onloadedmetadata = () => {
                    showElement(cameraFeed);
                    showElement(guideText);
                    hideElement(startCameraBtn);
                    showElement(takePhotoBtn);
                    
                    // Inicializar el recuadro de recorte sobre el video
                    initializeCropBox(); 
                    
                    showStatus('✅ Cámara lista. Ajusta el recuadro rojo sobre la identificación.');
                    updateCropBoxStyle();
                };
                
            } catch (error) {
                console.error('Error al acceder a la cámara:', error);
                
                if (error.name === 'NotAllowedError') {
                    showStatus('❌ Permiso de cámara denegado');
                    showElement(permissionInstructions);
                } else {
                    showStatus('❌ Error al acceder a la cámara');
                }
                showElement(startCameraBtn);
            }
        });

        // Evento: Tomar la foto
        takePhotoBtn.addEventListener('click', () => {
            if (!stream) {
                showStatus('❌ Error: No hay transmisión de cámara');
                return;
            }

            // Almacena la fecha/hora de la primera captura (FRONTAL)
            if (currentSide === 'front') {
                captureDateTime = new Date();
            }

            showStatus('📸 Procesando foto...');
            
            // Relación de escala entre píxeles de pantalla (DOM) y píxeles de video (MediaStream)
            const scaleX = cameraFeed.videoWidth / cameraFeed.offsetWidth;
            const scaleY = cameraFeed.videoHeight / cameraFeed.offsetHeight;
            
            // Calcular las coordenadas reales de la imagen a recortar
            imageCoordinates = {
                x: cropCoordinates.x * scaleX,
                y: cropCoordinates.y * scaleY,
                width: cropCoordinates.width * scaleX,
                height: cropCoordinates.height * scaleY
            };
            
            // 1. Dibujar el frame actual en el canvas oculto
            photoCanvas.width = cameraFeed.videoWidth;
            photoCanvas.height = cameraFeed.videoHeight;
            const context = photoCanvas.getContext('2d');
            context.drawImage(cameraFeed, 0, 0, cameraFeed.videoWidth, cameraFeed.videoHeight);
            
            // 2. Detener la cámara
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            
            // 3. Ocultar elementos de cámara y mostrar el botón de confirmación/recorte
            hideElement(cameraFeed);
            hideElement(cropBoxOverlay);
            hideElement(takePhotoBtn);
            hideElement(guideText);
            
            showStatus('Pulsa "Confirmar Recorte" para finalizar o "Rotar" si es necesario.');
            showElement(cropPhotoBtn);
        });

        // Evento: Recortar la imagen (Confirmación)
        cropPhotoBtn.addEventListener('click', () => {
            if (!imageCoordinates.width || !imageCoordinates.height) {
                showStatus('❌ Error al obtener coordenadas de recorte.');
                return;
            }

            showStatus('✂️ Confirmando y guardando imagen...');
            
            // 1. Recortar la imagen en el resultCanvas (usando coordenadas de imagen)
            resultCanvas.width = imageCoordinates.width;
            resultCanvas.height = imageCoordinates.height;
            
            const resultContext = resultCanvas.getContext('2d');
            
            resultContext.drawImage(
                photoCanvas,
                imageCoordinates.x, imageCoordinates.y, imageCoordinates.width, imageCoordinates.height,
                0, 0, imageCoordinates.width, imageCoordinates.height
            );
            
            // 2. Guardar la imagen *del resultCanvas*
            capturedImages[currentSide] = resultCanvas.toDataURL('image/jpeg', 0.9);
            
            // 3. Ocultar elementos de recorte y mostrar resultados
            hideElement(cropPhotoBtn);
            showElement(resultArea);

            // 4. Actualizar previsualización y botones
            updateResultPreview();
            
            if (currentSide === 'front') {
                showStatus('✅ ¡Frontal capturado! Usa Rotar si es necesario. Listo para el REVERSO.');
                
                // Mostrar takePhotoBtn con nueva función si no se ha capturado el reverso
                if (!capturedImages.back) {
                     takePhotoBtn.textContent = '📸 Capturar Reverso';
                     takePhotoBtn.onclick = captureBack;
                     showElement(takePhotoBtn);
                }

            } else {
                showStatus('✅ ¡Ambas caras capturadas! Genera o envía el documento PDF.');
                hideElement(takePhotoBtn); // Ocultar después de capturar el reverso
            }
        });

        // Función para capturar el reverso
        function captureBack() {
            currentSide = 'back';
            rotation = 0; 
            showStatus('🔄 Prepara la cámara para el REVERSO de la identificación');
            
            // Reiniciar la cámara
            restartCamera();
        }

        // Reiniciar cámara para nueva captura
        function restartCamera() {
            hideElement(resultArea);
            hideElement(takePhotoBtn);
            showElement(startCameraBtn);
            
            if (currentSide === 'front') {
                showStatus('Pulsa "Abrir cámara" para capturar el frontal');
            } else {
                showStatus('Pulsa "Abrir cámara" para capturar el reverso');
            }
        }
        
        // Función de PREVISUALIZACIÓN: Actualiza el resultado en tiempo real
        function updateResultPreview() {
            // Sincroniza el resultCanvas con la imagen guardada (rota)
            if (capturedImages[currentSide]) {
                const img = new Image();
                img.onload = function() {
                    resultCanvas.width = this.width;
                    resultCanvas.height = this.height;
                    resultCanvas.getContext('2d').drawImage(this, 0, 0);
                }
                img.src = capturedImages[currentSide];
            }

            // Actualizar la etiqueta del botón "Generar Documento"
            if (capturedImages.front && capturedImages.back) {
                generateDocBtn.textContent = '📄 Generar Documento PDF (Ambos listos)';
                generateDocBtn.classList.remove('bg-gray-500');
                generateDocBtn.classList.add('bg-green-600');
                showElement(sendEmailBtn);
            } else if (capturedImages.front) {
                generateDocBtn.textContent = '1/2 Frontal listo. Falta Reverso.';
                generateDocBtn.classList.remove('bg-green-600');
                generateDocBtn.classList.add('bg-gray-500');
                hideElement(sendEmailBtn);
            } else {
                generateDocBtn.textContent = '📄 Generar Documento PDF';
                generateDocBtn.classList.remove('bg-green-600');
                generateDocBtn.classList.add('bg-gray-500');
                hideElement(sendEmailBtn);
            }
        }

        // --- PDF y Email ---
        
        generateDocBtn.addEventListener('click', () => {
             generatePDF('download');
        });

        sendEmailBtn.addEventListener('click', () => {
            generatePDF('email');
        });

        function generatePDF(action) {
            if (!capturedImages.front || !capturedImages.back) {
                showStatus('❌ Necesitas capturar ambas caras de la identificación');
                return;
            }

            showStatus('📄 Generando documento PDF...');

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4'); 

            const idWidth_mm = 85.6; 
            const idHeight_mm = 53.98; 
            const margin = 20;

            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace(/[:.]/g, '-');
            const filename = `Identificacion_SEARS_${timestamp}.pdf`;
            
            // PÁGINA 1: Frontal
            pdf.setFontSize(14);
            pdf.text('SEARS CRÉDITO - Documento de Identificación', 105, 10, { align: 'center' });
            pdf.setFontSize(12);
            pdf.text('Identificación Frontal', margin, 20);

            // Añadir imagen frontal
            pdf.addImage(capturedImages.front, 'JPEG', margin, 25, idWidth_mm * 1.5, idHeight_mm * 1.5);

            // PÁGINA 2: Reverso
            pdf.addPage();
            pdf.setFontSize(14);
            pdf.text('SEARS CRÉDITO - Documento de Identificación', 1
