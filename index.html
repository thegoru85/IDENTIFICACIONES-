<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diagnóstico Cámara - SEARS</title>
  <style>
    body{font-family:system-ui,Arial;padding:18px;background:#f3f4f6}
    .card{max-width:760px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    video{max-width:100%;display:none;border-radius:6px;border:1px solid #ddd}
    pre{background:#111;color:#0f0;padding:10px;border-radius:6px;height:140px;overflow:auto}
    select,input,button{margin:6px 0;padding:8px;border-radius:6px;border:1px solid #ccc;width:100%}
    .row{display:flex;gap:8px}
    .col{flex:1}
    .hint{font-size:13px;color:#444}
  </style>
</head>
<body>
  <div class="card">
    <h2>Diagnóstico cámara</h2>
    <p class="hint">Sube esto a GitHub Pages (https) o abre en localhost. No usar file://</p>

    <label for="device">Cámara disponible</label>
    <select id="device"></select>

    <div class="row">
      <button id="open">Abrir cámara</button>
      <button id="stop">Detener</button>
    </div>

    <div style="margin-top:12px;">
      <video id="video" autoplay playsinline muted></video>
    </div>

    <p class="hint">Estado</p>
    <div id="status">—</div>

    <p class="hint">Log / errores (abre DevTools -> Console para info detallada)</p>
    <pre id="log"></pre>
  </div>

<script>
const deviceSel = document.getElementById('device');
const openBtn = document.getElementById('open');
const stopBtn = document.getElementById('stop');
const statusDiv = document.getElementById('status');
const logPre = document.getElementById('log');
const video = document.getElementById('video');

let currentStream = null;

function log(msg){
  console.log(msg);
  logPre.textContent += msg + '\\n';
  logPre.scrollTop = logPre.scrollHeight;
}
function logError(e){
  console.error(e);
  const name = e && e.name ? e.name : 'Error';
  const message = e && e.message ? e.message : String(e);
  log(`ERROR: ${name} - ${message}`);
}

async function ensureSecureContext(){
  if(location.protocol === 'file:'){
    statusDiv.textContent = 'ERROR: No funciona desde file://. Usa HTTPS o localhost.';
    throw new Error('Insecure context: file://');
  }
  if(location.hostname !== 'localhost' && location.protocol !== 'https:'){
    statusDiv.textContent = 'ADVERTENCIA: No estás en HTTPS. GitHub Pages usa HTTPS.';
    // Do not throw here; just warn.
  }
}

async function listCameras(){
  try{
    if(!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices){
      statusDiv.textContent = 'API navigator.mediaDevices no disponible';
      return;
    }
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d=>d.kind==='videoinput');
    deviceSel.innerHTML = cams.map((c,i)=>`<option value="${c.deviceId}">${c.label||('Cámara '+(i+1))}</option>`).join('') || '<option value="">(ninguna)</option>';
    log('Cámaras encontradas: ' + cams.length);
    if(cams.length===0) statusDiv.textContent = 'No se detectaron cámaras. Revisa permisos y conexión.';
  }catch(e){ logError(e); }
}

async function startCamera(){
  try{
    await ensureSecureContext();
    if(currentStream) stopCamera();
    const deviceId = deviceSel.value || undefined;
    const constraints = deviceId ? { video: { deviceId: { exact: deviceId } } } : { video: { facingMode: 'environment', width:{ideal:1280}, height:{ideal:720} } };
    statusDiv.textContent = 'Solicitando permiso de cámara...';
    log('getUserMedia constraints: ' + JSON.stringify(constraints));
    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = currentStream;
    video.style.display = 'block';
    await video.play().catch(()=>{/* ignore autoplay promise issues */});
    statusDiv.textContent = 'Cámara activa';
    log('Stream iniciado correctamente.');
  }catch(e){
    logError(e);
    statusDiv.textContent = 'Error al abrir cámara: ' + (e.name || e.message || e);
    // Si NotAllowedError mostrará info útil
    if(e.name === 'NotAllowedError') log('Permiso denegado por el usuario o por políticas del navegador.');
    if(e.name === 'NotFoundError') log('No se encontró dispositivo de cámara.');
  }
}

function stopCamera(){
  if(!currentStream) { statusDiv.textContent = 'No hay stream activo'; return; }
  currentStream.getTracks().forEach(t => t.stop());
  currentStream = null;
  video.srcObject = null;
  video.style.display = 'none';
  statusDiv.textContent = 'Stream detenido';
  log('Stream detenido.');
}

openBtn.addEventListener('click', startCamera);
stopBtn.addEventListener('click', stopCamera);

navigator.mediaDevices?.addEventListener?.('devicechange', async ()=>{ log('devicechange'); await listCameras(); });

(async function init(){
  try{
    log('Inicializando...');
    await ensureSecureContext();
    await listCameras();
    statusDiv.textContent = 'Listo. Selecciona una cámara y pulsa "Abrir cámara".';
  }catch(e){ logError(e); }
})();
</script>
</body>
</html>
