<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ID Camera App - SEARS</title>
<meta name="theme-color" content="#ef4444" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f8fafc;color:#111}
  .card{max-width:820px;margin:28px auto;padding:18px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,.08)}
  video, canvas, img{max-width:100%;border-radius:10px;border:1px solid #e6e7eb}
  .hidden{display:none!important}
  .small{font-size:13px;color:#6b7280}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:#ef4444;color:#fff;font-weight:600;border:none}
  .btn-ghost{background:#f3f4f6;color:#111}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
</style>
</head>
<body>
<div class="card">
  <div style="display:flex;align-items:center;gap:12px">
    <div style="background:#ef4444;color:#fff;font-weight:700;padding:10px 14px;border-radius:8px">SEARS</div>
    <h1 style="margin:0;font-size:20px">ID Camera App</h1>
  </div>

  <p class="small" style="margin-top:8px">Usa la c치mara trasera. Funciona en HTTPS o localhost. No se adjuntan im치genes autom치ticamente al correo; debes adjuntarlas manualmente.</p>

  <div id="live-area" style="margin-top:12px">
    <video id="video" autoplay playsinline muted class="" style="background:#000;display:none"></video>
    <div id="video-placeholder" style="width:100%;height:240px;background:#111;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff">Live view aparecer치 aqu칤</div>
    <div id="live-instructions" class="small" style="margin-top:6px">Pulsa "Abrir c치mara" y espera a que aparezca el video.</div>
  </div>

  <div style="margin-top:12px" class="grid2">
    <div>
      <button id="startBtn" class="btn" type="button">游닝 Abrir c치mara</button>
    </div>
    <div>
      <button id="takeBtn" class="btn btn-ghost" type="button" disabled>游닞 Tomar foto</button>
    </div>
  </div>

  <div style="margin-top:12px" class="grid2">
    <div>
      <div class="small">Lado actual: <strong id="sideLabel">FRONTAL</strong></div>
      <img id="previewFront" class="hidden" alt="Frontal preview">
      <div id="front-actions" class="small hidden" style="margin-top:6px">
        <button id="downloadFront" class="btn-ghost" type="button">Descargar frontal (JPG)</button>
      </div>
    </div>
    <div>
      <div class="small">Reverso: <strong id="sideLabel2">PENDIENTE</strong></div>
      <img id="previewBack" class="hidden" alt="Reverso preview">
      <div id="back-actions" class="small hidden" style="margin-top:6px">
        <button id="downloadBack" class="btn-ghost" type="button">Descargar reverso (JPG)</button>
      </div>
    </div>
  </div>

  <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
    <button id="restartBtn" class="btn-ghost" type="button">游대 Reiniciar</button>
    <button id="openMailBtn" class="btn" type="button">九괦잺 Abrir correo (preparado)</button>
    <button id="showDocBtn" class="btn-ghost" type="button">游늯 Generar vista impresi칩n</button>
  </div>

  <p id="status" class="small" style="margin-top:10px"></p>

  <!-- hidden canvases -->
  <canvas id="captureCanvas" class="hidden"></canvas>

  <!-- Documento simple para imprimir -->
  <div id="printDoc" class="hidden" style="margin-top:18px;padding:16px;border:1px dashed #e5e7eb;border-radius:8px;background:#fff">
    <h3 style="margin:0 0 8px 0">Documento generado</h3>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1 1 240px"><img id="docFront" alt="Frontal doc" style="border:1px solid #e6e7eb"></div>
      <div style="flex:1 1 240px"><img id="docBack" alt="Reverso doc" style="border:1px solid #e6e7eb"></div>
    </div>
    <p class="small" style="margin-top:8px">Imprime con Ctrl+P o usa la funci칩n de impresi칩n del m칩vil.</p>
  </div>
</div>

<script>
/*
  Flujo:
  - start camera (try facingMode:environment, fallback video:true)
  - show live view
  - take photo: capture currentSide (front then back)
  - for back: restart camera then take photo
  - save JPG dataURLs and provide download links
  - open mailto: with subject/body (images cannot be auto-attached)
*/

const startBtn = document.getElementById('startBtn');
const takeBtn = document.getElementById('takeBtn');
const restartBtn = document.getElementById('restartBtn');
const openMailBtn = document.getElementById('openMailBtn');
const video = document.getElementById('video');
const placeholder = document.getElementById('video-placeholder');
const status = document.getElementById('status');
const captureCanvas = document.getElementById('captureCanvas');
const previewFront = document.getElementById('previewFront');
const previewBack = document.getElementById('previewBack');
const downloadFront = document.getElementById('downloadFront');
const downloadBack = document.getElementById('downloadBack');
const sideLabel = document.getElementById('sideLabel');
const sideLabel2 = document.getElementById('sideLabel2');
const showDocBtn = document.getElementById('showDocBtn');
const printDoc = document.getElementById('printDoc');
const docFront = document.getElementById('docFront');
const docBack = document.getElementById('docBack');

let stream = null;
let currentSide = 'front'; // front -> then back
let images = { front: null, back: null };

// Helpers
function setStatus(txt) { status.textContent = txt; }
function showVideo() { video.style.display='block'; placeholder.style.display='none'; }
function hideVideo() { video.style.display='none'; placeholder.style.display='flex'; }

// Start camera: prefer rear camera, fallback to default
async function startCamera() {
  setStatus('Solicitando c치mara...');
  takeBtn.disabled = true;
  try {
    // First try forcing environment (rear). Some browsers reject exact constraint, so try loose then exact fallback.
    const constraintsList = [
      { video: { facingMode: { ideal: 'environment' }, width:{ideal:1280}, height:{ideal:720} } },
      { video: { facingMode: 'environment' } },
      { video: true }
    ];
    let got = false;
    for (const c of constraintsList) {
      try {
        const s = await navigator.mediaDevices.getUserMedia(c);
        stream = s;
        got = true;
        break;
      } catch (err) {
        // continue to next fallback
      }
    }
    if (!got) throw new Error('No se pudo acceder a la c치mara');
    video.srcObject = stream;
    showVideo();
    setStatus('C치mara activa. Pulsa "Tomar foto".');
    takeBtn.disabled = false;
  } catch (e) {
    console.error(e);
    setStatus('Error al acceder a la c치mara. Revisa permisos y que la p치gina est칠 en HTTPS o localhost.');
    takeBtn.disabled = true;
  }
}

// Stop camera
function stopCamera() {
  if (!stream) return;
  stream.getTracks().forEach(t => t.stop());
  stream = null;
  hideVideo();
  setStatus('C치mara detenida.');
}

// Capture current frame to JPG dataURL
function captureJPG(quality = 0.92) {
  if (!video || video.videoWidth === 0) {
    // fallback draw placeholder if video not available (shouldn't happen)
    setStatus('Error: video no disponible para capturar.');
    return null;
  }
  const w = video.videoWidth;
  const h = video.videoHeight;
  captureCanvas.width = w;
  captureCanvas.height = h;
  const ctx = captureCanvas.getContext('2d');
  ctx.drawImage(video, 0, 0, w, h);
  return captureCanvas.toDataURL('image/jpeg', quality);
}

// Download helper
function downloadDataURL(dataURL, filename) {
  const a = document.createElement('a');
  a.href = dataURL;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// UI Flow handlers
startBtn.addEventListener('click', async () => {
  await startCamera();
});

takeBtn.addEventListener('click', async () => {
  if (!stream) { setStatus('C치mara no activa. Pulsa "Abrir c치mara".'); return; }
  setStatus('Capturando ' + currentSide + '...');
  const data = captureJPG(0.92);
  if (!data) { setStatus('Error al capturar.'); return; }

  const ts = new Date().toISOString().slice(0,19).replace(/[:.]/g,'-');
  if (currentSide === 'front') {
    images.front = data;
    previewFront.src = data;
    previewFront.classList.remove('hidden');
    downloadFront.parentElement.classList.remove('hidden');
    downloadFront.onclick = () => downloadDataURL(images.front, `identificacion-frontal-${ts}.jpg`);
    sideLabel2.textContent = 'PENDIENTE';
    setStatus('Frontal guardado. Ahora capture el reverso.');
    // prepare for back: stop and allow user to restart camera
    stopCamera();
    currentSide = 'back';
    sideLabel.textContent = 'REVERSO (preparar)';
    // auto-restart camera after short delay to simplify flow
    setTimeout(async () => {
      sideLabel.textContent = 'REVERSO';
      await startCamera();
    }, 600);
  } else {
    images.back = data;
    previewBack.src = data;
    previewBack.classList.remove('hidden');
    downloadBack.parentElement.classList.remove('hidden');
    downloadBack.onclick = () => downloadDataURL(images.back, `identificacion-reverso-${ts}.jpg`);
    setStatus('Reverso guardado. Listo para descargar o enviar.');
    stopCamera();
    currentSide = 'done';
    sideLabel.textContent = 'COMPLETADO';
    sideLabel2.textContent = 'LISTO';
    // set doc images
    docFront.src = images.front || '';
    docBack.src = images.back || '';
  }
});

// restart button clears and reloads state
restartBtn.addEventListener('click', () => {
  stopCamera();
  images = { front: null, back: null };
  previewFront.src = ''; previewBack.src = '';
  previewFront.classList.add('hidden'); previewBack.classList.add('hidden');
  downloadFront.parentElement.classList.add('hidden'); downloadBack.parentElement.classList.add('hidden');
  sideLabel.textContent = 'FRONTAL';
  sideLabel2.textContent = 'PENDIENTE';
  currentSide = 'front';
  setStatus('Reiniciado. Pulsa "Abrir c치mara" para comenzar.');
  printDoc.classList.add('hidden');
});

// open mail client (mailto) - cannot attach files; instruction included
openMailBtn.addEventListener('click', () => {
  const subject = encodeURIComponent('Identificaciones SEARS - [Nombre cliente]');
  let body = 'Adjunto frontal y reverso de identificaci칩n.\n\nInstrucciones:\n- Adjunta los archivos JPG descargados desde la aplicaci칩n.\n- Nombre sugerido: identificacion-frontal-YYYY-MM-DDThh-mm-ss.jpg\n\nAtentamente,\n';
  body = encodeURIComponent(body);
  // mailto
  const mailto = `mailto:?subject=${subject}&body=${body}`;
  window.location.href = mailto;
  setStatus('Se abri칩 el cliente de correo. Adjunta manualmente las im치genes descargadas.');
});

// show printable doc
showDocBtn.addEventListener('click', () => {
  if (!images.front || !images.back) {
    setStatus('Necesitas ambas im치genes para generar vista de impresi칩n.');
    return;
  }
  docFront.src = images.front;
  docBack.src = images.back;
  printDoc.classList.remove('hidden');
  printDoc.scrollIntoView({behavior:'smooth'});
  setStatus('Vista de documento lista. Usa imprimir del navegador si deseas una copia f칤sica.');
});

// keyboard/mobile back handling: when page unload, stop camera
window.addEventListener('pagehide', () => stopCamera());
window.addEventListener('unload', () => stopCamera());

// initial UI state
(function init(){
  setStatus('Listo. Pulsa "Abrir c치mara". Aseg칰rate de que el sitio est칠 en HTTPS o uses localhost.');
  previewFront.classList.add('hidden');
  previewBack.classList.add('hidden');
  downloadFront.parentElement.classList.add('hidden');
  downloadBack.parentElement.classList.add('hidden');
})();
</script>
</body>
</html>
