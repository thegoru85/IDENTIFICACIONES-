<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID Camera App</title>
    <!-- Incluye Tailwind CSS para un estilo rápido y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #camera-feed, #cropped-canvas {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: none;
            cursor: crosshair;
        }
        #crop-container {
            position: relative;
            display: none;
            width: 100%;
            height: auto;
        }
        #crop-box {
            position: absolute;
            border: 2px dashed #FFF;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            cursor: move;
            display: none;
        }
    </style>
</head>
<body class="bg-red-600 dark:bg-red-800 text-gray-800 dark:text-gray-200 p-4 min-h-screen flex flex-col items-center justify-center">

    <div class="relative max-w-md w-full bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 space-y-6 flex flex-col items-center">
        <!-- Logo en la esquina superior izquierda -->
        <img src="https://placehold.co/60x60/ffffff/000000?text=SEARS" alt="Logo de Sears" class="absolute top-4 left-4 rounded-full shadow-md">

        <!-- Título de la aplicación -->
        <h1 class="text-3xl font-bold text-center text-gray-900 dark:text-white mt-8">ID Camera App</h1>
        <!-- Logo de Crédito Sears -->
        <div class="font-bold text-2xl text-center text-indigo-600 dark:text-indigo-400 tracking-wider">
            CRÉDITO SEARS
        </div>
        <p class="text-sm text-center text-gray-500 dark:text-gray-400">Toma una foto, recorta y envía por correo electrónico.</p>

        <!-- Contenedor principal de la aplicación -->
        <div id="app-container" class="w-full flex flex-col items-center space-y-4">

            <!-- Mensajes de estado -->
            <div id="status-message" class="text-sm font-medium text-gray-600 dark:text-gray-300 transition-opacity duration-300">
                Pulsa "Abrir cámara" para empezar.
            </div>
            
            <!-- Contenedor para instrucciones de permiso -->
            <div id="permission-instructions" class="w-full bg-red-100 dark:bg-red-800 p-4 rounded-lg text-red-700 dark:text-red-200 hidden">
                <h3 class="font-bold text-lg mb-2">Permiso de cámara denegado</h3>
                <p class="mb-2">Por favor, habilita el acceso a la cámara en la configuración de tu navegador. Sigue estos pasos:</p>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li>**En Chrome (Android):** Toca los tres puntos > Configuración > Configuración de sitios > Cámara.</li>
                    <li>**En Safari (iPhone/iPad):** Ve a Ajustes > Safari > Cámara.</li>
                </ul>
                <p class="mt-2 text-xs text-red-600 dark:text-red-300">Una vez que hayas habilitado el permiso, vuelve a la aplicación y pulsa "Volver a empezar".</p>
            </div>

            <!-- Feed de la cámara y canvas para la foto -->
            <div id="camera-view" class="w-full flex justify-center">
                <video id="camera-feed" class="rounded-lg shadow-md" autoplay playsinline></video>
                <canvas id="photo-canvas" class="hidden"></canvas>
            </div>

            <!-- Contenedor para el recorte -->
            <div id="crop-container" class="w-full flex justify-center mt-4">
                <canvas id="cropped-canvas" class="rounded-lg shadow-md"></canvas>
                <div id="crop-box"></div>
            </div>

            <!-- Botones de acción -->
            <div id="button-container" class="w-full flex flex-col md:flex-row justify-center space-y-2 md:space-y-0 md:space-x-4 mt-4">
                <button id="start-camera" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md">
                    Abrir cámara
                </button>
                <button id="take-photo" class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md hidden">
                    Tomar foto
                </button>
                <button id="crop-photo" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md hidden">
                    Recortar
                </button>
            </div>

            <!-- Área de resultados -->
            <div id="result-area" class="w-full flex flex-col items-center space-y-4 mt-4 hidden">
                <p class="text-center text-gray-600 dark:text-gray-400">Imagen recortada:</p>
                <canvas id="result-canvas" class="rounded-lg shadow-md max-w-full h-auto border border-gray-300 dark:border-gray-700"></canvas>
                <div class="w-full flex flex-col md:flex-row justify-center space-y-2 md:space-y-0 md:space-x-4">
                    <button id="download-btn" class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md">
                        Descargar imagen
                    </button>
                    <a id="email-link" class="w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md text-center flex items-center justify-center" href="#">
                        Enviar por correo
                    </a>
                </div>
                <button id="restart-btn" class="text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 mt-2">
                    Volver a empezar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Declaración de variables globales
        const cameraFeed = document.getElementById('camera-feed');
        const photoCanvas = document.getElementById('photo-canvas');
        const croppedCanvas = document.getElementById('cropped-canvas');
        const resultCanvas = document.getElementById('result-canvas');
        const startCameraBtn = document.getElementById('start-camera');
        const takePhotoBtn = document.getElementById('take-photo');
        const cropPhotoBtn = document.getElementById('crop-photo');
        const downloadBtn = document.getElementById('download-btn');
        const emailLink = document.getElementById('email-link');
        const restartBtn = document.getElementById('restart-btn');
        const statusMessage = document.getElementById('status-message');
        const cropBox = document.getElementById('crop-box');
        const resultArea = document.getElementById('result-area');
        const cropContainer = document.getElementById('crop-container');
        const permissionInstructions = document.getElementById('permission-instructions');

        let stream; // Variable para la transmisión de la cámara
        let originalImage; // Almacena la imagen original para el recorte
        let isCropping = false;
        let startX, startY;

        // Función para mostrar mensajes de estado
        function showStatus(message) {
            statusMessage.textContent = message;
        }

        // Función para cambiar la visibilidad de los elementos
        function showElement(el) { el.classList.remove('hidden'); }
        function hideElement(el) { el.classList.add('hidden'); }

        // Evento: Iniciar la cámara
        startCameraBtn.addEventListener('click', async () => {
            showStatus('Accediendo a la cámara...');
            hideElement(permissionInstructions);
            try {
                // Intenta primero con la cámara trasera (entorno)
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            } catch (envErr) {
                console.warn('Cámara trasera no encontrada. Intentando con cualquier cámara...');
                try {
                    // Si falla, intenta con cualquier cámara disponible
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                } catch (genericErr) {
                    // Si falla por segunda vez, lanza el error original para el manejo
                    throw genericErr;
                }
            }

            cameraFeed.srcObject = stream;
            showElement(cameraFeed);
            hideElement(startCameraBtn);
            showElement(takePhotoBtn);
            showStatus('Cámara lista. Pulsa "Tomar foto"');
        });

        // Evento: Tomar la foto
        takePhotoBtn.addEventListener('click', () => {
            // Detener la transmisión de la cámara
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            // Ocultar la cámara y mostrar el canvas de recorte
            hideElement(cameraFeed);
            hideElement(takePhotoBtn);
            showElement(cropContainer);
            showElement(croppedCanvas);

            // Redimensionar el canvas para que coincida con el video y dibujar la imagen
            photoCanvas.width = cameraFeed.videoWidth;
            photoCanvas.height = cameraFeed.videoHeight;
            const photoContext = photoCanvas.getContext('2d');
            photoContext.drawImage(cameraFeed, 0, 0, photoCanvas.width, photoCanvas.height);

            // Almacenar la imagen original y prepararla para el recorte
            originalImage = new Image();
            originalImage.src = photoCanvas.toDataURL('image/png');
            originalImage.onload = () => {
                // Configurar el canvas para el recorte
                croppedCanvas.width = originalImage.width;
                croppedCanvas.height = originalImage.height;
                const croppedContext = croppedCanvas.getContext('2d');
                croppedContext.drawImage(originalImage, 0, 0);

                showStatus('Arrastra para seleccionar el área de recorte.');
                showElement(cropPhotoBtn);
                showElement(cropBox);
            };
        });

        // Lógica para arrastrar y soltar el recuadro de recorte
        croppedCanvas.addEventListener('mousedown', (e) => {
            isCropping = true;
            const rect = croppedCanvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            cropBox.style.left = `${startX}px`;
            cropBox.style.top = `${startY}px`;
            cropBox.style.width = '0px';
            cropBox.style.height = '0px';
        });

        croppedCanvas.addEventListener('mousemove', (e) => {
            if (!isCropping) return;
            const rect = croppedCanvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            const width = currentX - startX;
            const height = currentY - startY;
            cropBox.style.width = `${Math.abs(width)}px`;
            cropBox.style.height = `${Math.abs(height)}px`;
            cropBox.style.left = `${Math.min(startX, currentX)}px`;
            cropBox.style.top = `${Math.min(startY, currentY)}px`;
        });

        croppedCanvas.addEventListener('mouseup', () => {
            isCropping = false;
        });

        // Evento: Recortar la imagen
        cropPhotoBtn.addEventListener('click', () => {
            const cropRect = cropBox.getBoundingClientRect();
            const canvasRect = croppedCanvas.getBoundingClientRect();

            // Calcular las coordenadas de recorte en el canvas original
            const scaleX = croppedCanvas.width / canvasRect.width;
            const scaleY = croppedCanvas.height / canvasRect.height;

            const cropX = (cropRect.left - canvasRect.left) * scaleX;
            const cropY = (cropRect.top - canvasRect.top) * scaleY;
            const cropWidth = cropRect.width * scaleX;
            const cropHeight = cropRect.height * scaleY;

            // Dibujar la imagen recortada en el canvas de resultados
            resultCanvas.width = cropWidth;
            resultCanvas.height = cropHeight;
            const resultContext = resultCanvas.getContext('2d');
            resultContext.drawImage(originalImage, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

            // Ocultar elementos de recorte y mostrar el área de resultados
            hideElement(cropContainer);
            hideElement(croppedCanvas);
            hideElement(cropPhotoBtn);
            showElement(resultArea);
            showStatus('¡Imagen recortada!');

            // Preparar el enlace de descarga
            const dataURL = resultCanvas.toDataURL('image/png');
            downloadBtn.href = dataURL;
            downloadBtn.download = `ID-recortada-${new Date().toISOString()}.png`;

            // Preparar el enlace de correo
            emailLink.href = `mailto:?subject=Foto%20de%20identificación%20recortada&body=Adjunto%20la%20imagen%20recortada%20de%20la%20identificación.`;
        });

        // Evento: Reiniciar la aplicación
        restartBtn.addEventListener('click', () => {
            // Ocultar todo y mostrar solo el botón de inicio
            hideElement(cameraFeed);
            hideElement(takePhotoBtn);
            hideElement(cropContainer);
            hideElement(croppedCanvas);
            hideElement(cropPhotoBtn);
            hideElement(resultArea);
            hideElement(permissionInstructions);
            showElement(startCameraBtn);
            showStatus('Pulsa "Abrir cámara" para empezar.');
        });

        // Manejo de la lógica para dispositivos táctiles
        croppedCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = croppedCanvas.getBoundingClientRect();
            startX = touch.clientX - rect.left;
            startY = touch.clientY - rect.top;
            isCropping = true;

            // Inicializar el cuadro de recorte
            cropBox.style.left = `${startX}px`;
            cropBox.style.top = `${startY}px`;
            cropBox.style.width = '0px';
            cropBox.style.height = '0px';
        });

        croppedCanvas.addEventListener('touchmove', (e) => {
            if (!isCropping) return;
            e.preventDefault();
            const touch = e.touches[0];
            const rect = croppedCanvas.getBoundingClientRect();
            const currentX = touch.clientX - rect.left;
            const currentY = touch.clientY - rect.top;
            const width = currentX - startX;
            const height = currentY - startY;
            cropBox.style.width = `${Math.abs(width)}px`;
            cropBox.style.height = `${Math.abs(height)}px`;
            cropBox.style.left = `${Math.min(startX, currentX)}px`;
            cropBox.style.top = `${Math.min(startY, currentY)}px`;
        });

        croppedCanvas.addEventListener('touchend', () => {
            isCropping = false;
        });
    </script>
</body>
</html>
