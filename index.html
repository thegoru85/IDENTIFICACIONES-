<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID Camera App - SEARS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #camera-feed {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: none;
        }
        #cropped-canvas {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: none;
            cursor: crosshair;
        }
        #crop-container {
            position: relative;
            display: none;
            width: 100%;
            height: auto;
        }
        #crop-box {
            position: absolute;
            border: 2px dashed #FFF;
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            cursor: move;
            display: none;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-red-600 dark:bg-red-800 text-gray-800 dark:text-gray-200 p-4 min-h-screen flex flex-col items-center justify-center">

    <div class="relative max-w-md w-full bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 space-y-6 flex flex-col items-center">
        <!-- Logo en la esquina superior izquierda -->
        <div class="absolute top-4 left-4 w-16 h-16 bg-red-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
            SEARS
        </div>

        <!-- T√≠tulo de la aplicaci√≥n -->
        <h1 class="text-3xl font-bold text-center text-gray-900 dark:text-white mt-8">ID Camera App</h1>
        <!-- Logo de Cr√©dito Sears -->
        <div class="font-bold text-2xl text-center text-indigo-600 dark:text-indigo-400 tracking-wider">
            CR√âDITO SEARS
        </div>
        <p class="text-sm text-center text-gray-500 dark:text-gray-400">Toma una foto, recorta y env√≠a por correo electr√≥nico.</p>

        <!-- Contenedor principal de la aplicaci√≥n -->
        <div id="app-container" class="w-full flex flex-col items-center space-y-4">

            <!-- Mensajes de estado -->
            <div id="status-message" class="text-sm font-medium text-gray-600 dark:text-gray-300 transition-opacity duration-300 text-center">
                Pulsa "Abrir c√°mara" para empezar.
            </div>
            
            <!-- Contenedor para instrucciones de permiso -->
            <div id="permission-instructions" class="w-full bg-red-100 dark:bg-red-800 p-4 rounded-lg text-red-700 dark:text-red-200 hidden">
                <h3 class="font-bold text-lg mb-2">Permiso de c√°mara denegado</h3>
                <p class="mb-2">Para usar esta aplicaci√≥n, necesitas permitir el acceso a la c√°mara:</p>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Chrome/Edge:</strong> Haz clic en el icono de c√°mara bloqueada en la barra de direcciones</li>
                    <li><strong>Firefox:</strong> Ve a Configuraci√≥n > Privacidad y Seguridad > Permisos de la c√°mara</li>
                    <li><strong>Safari:</strong> Preferencias > Sitios web > C√°mara</li>
                </ul>
            </div>

            <!-- Feed de la c√°mara -->
            <div id="camera-view" class="w-full flex justify-center">
                <video id="camera-feed" class="rounded-lg shadow-md" autoplay playsinline></video>
            </div>

            <!-- Canvas para la foto capturada -->
            <canvas id="photo-canvas" class="hidden"></canvas>

            <!-- Contenedor para el recorte -->
            <div id="crop-container" class="w-full flex justify-center mt-4 relative">
                <canvas id="cropped-canvas" class="rounded-lg shadow-md"></canvas>
                <div id="crop-box"></div>
            </div>

            <!-- Botones de acci√≥n -->
            <div id="button-container" class="w-full flex flex-col md:flex-row justify-center space-y-2 md:space-y-0 md:space-x-4 mt-4">
                <button id="start-camera" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md">
                    üì∑ Abrir c√°mara
                </button>
                <button id="take-photo" class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md hidden">
                    üì∏ Tomar foto
                </button>
                <button id="crop-photo" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md hidden">
                    ‚úÇÔ∏è Recortar
                </button>
            </div>

            <!-- √Årea de resultados -->
            <div id="result-area" class="w-full flex flex-col items-center space-y-4 mt-4 hidden">
                <p class="text-center text-gray-600 dark:text-gray-400 font-medium">Imagen recortada:</p>
                <canvas id="result-canvas" class="rounded-lg shadow-md max-w-full h-auto border-2 border-gray-300 dark:border-gray-700"></canvas>
                <div class="w-full flex flex-col md:flex-row justify-center space-y-2 md:space-y-0 md:space-x-4">
                    <button id="download-btn" class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md">
                        üíæ Descargar
                    </button>
                    <button id="rotate-btn" class="w-full md:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-6 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md">
                        üîÑ Rotar 90¬∞
                    </button>
                    <button id="email-link" class="w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-full transition-all duration-200 transform hover:scale-105 shadow-md">
                    ‚úâÔ∏è Enviar correo
                    </button>
                </div>
                <button id="restart-btn" class="text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 mt-4 font-medium">
                    üîÅ Volver a empezar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Declaraci√≥n de variables globales
        const cameraFeed = document.getElementById('camera-feed');
        const photoCanvas = document.getElementById('photo-canvas');
        const croppedCanvas = document.getElementById('cropped-canvas');
        const resultCanvas = document.getElementById('result-canvas');
        const startCameraBtn = document.getElementById('start-camera');
        const takePhotoBtn = document.getElementById('take-photo');
        const cropPhotoBtn = document.getElementById('crop-photo');
        const downloadBtn = document.getElementById('download-btn');
        const rotateBtn = document.getElementById('rotate-btn');
        const emailLink = document.getElementById('email-link');
        const restartBtn = document.getElementById('restart-btn');
        const statusMessage = document.getElementById('status-message');
        const cropBox = document.getElementById('crop-box');
        const resultArea = document.getElementById('result-area');
        const cropContainer = document.getElementById('crop-container');
        const permissionInstructions = document.getElementById('permission-instructions');

        let stream = null;
        let originalImage = null;
        let isCropping = false;
        let startX, startY, endX, endY;
        let rotation = 0;
        let cropCoordinates = { x: 0, y: 0, width: 0, height: 0 };

        // Funci√≥n para mostrar mensajes de estado
        function showStatus(message) {
            statusMessage.textContent = message;
        }

        // Funci√≥n para cambiar la visibilidad de los elementos
        function showElement(el) { 
            el.classList.remove('hidden'); 
            el.style.display = 'block';
        }
        function hideElement(el) { 
            el.classList.add('hidden'); 
            el.style.display = 'none';
        }

        // Evento: Iniciar la c√°mara
        startCameraBtn.addEventListener('click', async () => {
            showStatus('üîÑ Accediendo a la c√°mara...');
            hideElement(permissionInstructions);
            
            try {
                // Intentar con la c√°mara trasera primero
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                cameraFeed.srcObject = stream;
                showElement(cameraFeed);
                hideElement(startCameraBtn);
                showElement(takePhotoBtn);
                showStatus('‚úÖ C√°mara lista. Apunta la identificaci√≥n y pulsa "Tomar foto"');
                
            } catch (error) {
                console.error('Error al acceder a la c√°mara:', error);
                
                if (error.name === 'NotAllowedError') {
                    showStatus('‚ùå Permiso de c√°mara denegado');
                    showElement(permissionInstructions);
                } else if (error.name === 'NotFoundError') {
                    showStatus('‚ùå No se encontr√≥ ninguna c√°mara');
                } else {
                    showStatus('‚ùå Error al acceder a la c√°mara');
                }
                
                showElement(startCameraBtn);
            }
        });

        // Evento: Tomar la foto
        takePhotoBtn.addEventListener('click', () => {
            if (!stream) {
                showStatus('‚ùå Error: No hay transmisi√≥n de c√°mara');
                return;
            }

            showStatus('üì∏ Procesando foto...');
            
            // Configurar el canvas con las dimensiones del video
            const videoWidth = cameraFeed.videoWidth;
            const videoHeight = cameraFeed.videoHeight;
            
            photoCanvas.width = videoWidth;
            photoCanvas.height = videoHeight;
            croppedCanvas.width = videoWidth;
            croppedCanvas.height = videoHeight;
            
            // Dibujar el frame actual del video en el canvas
            const context = photoCanvas.getContext('2d');
            context.drawImage(cameraFeed, 0, 0, videoWidth, videoHeight);
            
            // Detener la c√°mara
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            
            // Ocultar elementos de c√°mara y mostrar √°rea de recorte
            hideElement(cameraFeed);
            hideElement(takePhotoBtn);
            showElement(cropContainer);
            showElement(croppedCanvas);
            
            // Dibujar la imagen en el canvas de recorte
            const cropContext = croppedCanvas.getContext('2d');
            cropContext.drawImage(photoCanvas, 0, 0);
            
            // Inicializar el cuadro de recorte
            initializeCropBox();
            
            showStatus('‚¨ÖÔ∏è‚û°Ô∏è Arrastra para seleccionar el √°rea de la identificaci√≥n');
            showElement(cropPhotoBtn);
        });

        // Inicializar el cuadro de recorte
        function initializeCropBox() {
            const canvas = croppedCanvas;
            const rect = canvas.getBoundingClientRect();
            
            // Tama√±o inicial del cuadro de recorte (80% del canvas)
            const boxWidth = canvas.width * 0.8;
            const boxHeight = canvas.height * 0.6;
            const boxX = (canvas.width - boxWidth) / 2;
            const boxY = (canvas.height - boxHeight) / 2;
            
            // Configurar el cuadro de recorte
            cropBox.style.position = 'absolute';
            cropBox.style.border = '2px dashed #00ff00';
            cropBox.style.backgroundColor = 'rgba(0, 255, 0, 0.1)';
            cropBox.style.boxShadow = '0 0 0 9999px rgba(0, 0, 0, 0.7)';
            cropBox.style.cursor = 'move';
            
            // Posicionar el cuadro
            cropBox.style.left = boxX + 'px';
            cropBox.style.top = boxY + 'px';
            cropBox.style.width = boxWidth + 'px';
            cropBox.style.height = boxHeight + 'px';
            
            showElement(cropBox);
            
            // Guardar coordenadas iniciales
            cropCoordinates = {
                x: boxX,
                y: boxY,
                width: boxWidth,
                height: boxHeight
            };
        }

        // Eventos para arrastrar el cuadro de recorte
        cropBox.addEventListener('mousedown', startDragging);
        cropBox.addEventListener('touchstart', startDragging);

        function startDragging(e) {
            e.preventDefault();
            isCropping = true;
            
            const rect = croppedCanvas.getBoundingClientRect();
            if (e.type === 'mousedown') {
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
            } else {
                startX = e.touches[0].clientX - rect.left;
                startY = e.touches[0].clientY - rect.top;
            }
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);
            document.addEventListener('mouseup', stopDragging);
            document.addEventListener('touchend', stopDragging);
        }

        function drag(e) {
            if (!isCropping) return;
            e.preventDefault();
            
            const rect = croppedCanvas.getBoundingClientRect();
            let currentX, currentY;
            
            if (e.type === 'mousemove') {
                currentX = e.clientX - rect.left;
                currentY = e.clientY - rect.top;
            } else {
                currentX = e.touches[0].clientX - rect.left;
                currentY = e.touches[0].clientY - rect.top;
            }
            
            const deltaX = currentX - startX;
            const deltaY = currentY - startY;
            
            // Calcular nueva posici√≥n manteniendo el cuadro dentro del canvas
            const newX = Math.max(0, Math.min(croppedCanvas.width - cropCoordinates.width, cropCoordinates.x + deltaX));
            const newY = Math.max(0, Math.min(croppedCanvas.height - cropCoordinates.height, cropCoordinates.y + deltaY));
            
            // Actualizar posici√≥n
            cropBox.style.left = newX + 'px';
            cropBox.style.top = newY + 'px';
            
            // Actualizar coordenadas
            cropCoordinates.x = newX;
            cropCoordinates.y = newY;
            
            startX = currentX;
            startY = currentY;
        }

        function stopDragging() {
            isCropping = false;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('mouseup', stopDragging);
            document.removeEventListener('touchend', stopDragging);
        }

        // Evento: Recortar la imagen
        cropPhotoBtn.addEventListener('click', () => {
            if (!cropCoordinates.width || !cropCoordinates.height) {
                showStatus('‚ùå Primero selecciona un √°rea para recortar');
                return;
            }

            showStatus('‚úÇÔ∏è Recortando imagen...');
            
            // Configurar el canvas de resultado
            resultCanvas.width = cropCoordinates.width;
            resultCanvas.height = cropCoordinates.height;
            
            const resultContext = resultCanvas.getContext('2d');
            
            // Dibujar solo el √°rea recortada
            resultContext.drawImage(
                photoCanvas,
                cropCoordinates.x, cropCoordinates.y, cropCoordinates.width, cropCoordinates.height,
                0, 0, cropCoordinates.width, cropCoordinates.height
            );
            
            // Ocultar elementos de recorte y mostrar resultados
            hideElement(cropContainer);
            hideElement(cropPhotoBtn);
            showElement(resultArea);
            
            showStatus('‚úÖ ¬°Imagen recortada! Lista para descargar o enviar.');
        });

        // Evento: Descargar imagen
        downloadBtn.addEventListener('click', () => {
            const dataURL = resultCanvas.toDataURL('image/jpeg', 0.9);
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
            link.download = `identificacion-sears-${timestamp}.jpg`;
            link.href = dataURL;
            link.click();
            showStatus('üíæ Imagen descargada correctamente');
        });

        // Evento: Rotar imagen
        rotateBtn.addEventListener('click', () => {
            rotation = (rotation + 90) % 360;
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            if (rotation === 90 || rotation === 270) {
                tempCanvas.width = resultCanvas.height;
                tempCanvas.height = resultCanvas.width;
            } else {
                tempCanvas.width = resultCanvas.width;
                tempCanvas.height = resultCanvas.height;
            }
            
            tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
            tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
            tempCtx.rotate(rotation * Math.PI / 180);
            tempCtx.drawImage(resultCanvas, -resultCanvas.width / 2, -resultCanvas.height / 2);
            
            resultCanvas.width = tempCanvas.width;
            resultCanvas.height = tempCanvas.height;
            resultCanvas.getContext('2d').drawImage(tempCanvas, 0, 0);
            
            showStatus(`üîÑ Imagen rotada ${rotation} grados`);
        });

        // Evento: Enviar por correo
        emailLink.addEventListener('click', (e) => {
            e.preventDefault();
            
            const dataURL = resultCanvas.toDataURL('image/jpeg', 0.8);
            const fecha = new Date().toLocaleDateString('es-MX');
            const subject = `Identificaci√≥n Cliente SEARS - ${fecha}`;
            const body = `Estimado equipo,%0D%0A%0D%0AAdjunto la identificaci√≥n del cliente procesada.%0D%0A%0D%0AFecha: ${fecha}%0D%0A%0D%0ASaludos cordiales.`;
            
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${body}`;
            window.location.href = mailtoLink;
            
            showStatus('‚úâÔ∏è Abriendo cliente de correo...');
        });

        // Evento: Reiniciar la aplicaci√≥n
        restartBtn.addEventListener('click', () => {
            // Limpiar todo
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Ocultar todos los elementos
            hideElement(cameraFeed);
            hideElement(takePhotoBtn);
            hideElement(cropContainer);
            hideElement(croppedCanvas);
            hideElement(cropBox);
            hideElement(cropPhotoBtn);
            hideElement(resultArea);
            hideElement(permissionInstructions);
            
            // Mostrar solo el bot√≥n de inicio
            showElement(startCameraBtn);
            
            // Reiniciar variables
            rotation = 0;
            originalImage = null;
            cropCoordinates = { x: 0, y: 0, width: 0, height: 0 };
            
            showStatus('üîÑ Pulsa "Abrir c√°mara" para empezar.');
        });

        // Manejo de errores globales
        window.addEventListener('error', (e) => {
            console.error('Error global:', e);
            showStatus('‚ùå Ocurri√≥ un error inesperado');
        });
    </script>
</body>
</html>
